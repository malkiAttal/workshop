name: Microservice Testing CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: inventory
        ports:
          - "5432:5432"
        options: >-
          --health-cmd="pg_isready -U user -d inventory"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Poetry
        run: pip install poetry

      - name: Install Dependencies
        run: poetry install

      - name: Start Service B
        run: |
          nohup poetry run uvicorn service-b.main:app \
            --host 0.0.0.0 --port 8001 &
          sleep 4

      - name: Verify Service B is running
        run: |
          for i in {1..10}; do
            curl -X POST http://localhost:8001/sum \
              -H "Content-Type: application/json" \
              -d '{"numbers":[1]}' && break
            echo "Waiting for Service B..."
            sleep 2
          done

      - name: Start Service A
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/inventory
          SERVICE_B_URL: http://localhost:8001
        run: |
          nohup poetry run uvicorn service-a.main:app \
            --host 0.0.0.0 --port 8000 &
          sleep 4

      - name: Verify Service A is reachable
        run: curl http://localhost:8000/items

      - name: Integration Tests
        run: poetry run pytest tests/integration

      - name: Pact Consumer Tests
        run: poetry run pytest tests/contract/test_sum_contract.py

      - name: Verify Pact File Exists
        run: test -f pacts/service-a-service-b.json

      - name: Pact Provider Verification
        run: poetry run pytest tests/contract/test_provider_verification.py

      - name: Component Tests
        run: poetry run pytest tests/component
